<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Audio Codec Samples - Different BPS</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <script src="https://unpkg.com/wavesurfer.js@6.6.3/dist/wavesurfer.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #text1 { font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 20px; color: #333; }
        #intro { text-align: center; margin-bottom: 30px; color: #666; }
        .content-container { max-width: 1200px; margin: 30px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .content-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .inlineTable { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .inlineTable th, .inlineTable td { padding: 12px; text-align: center; border: 1px solid #ddd; }
        .inlineTable th { background: #f8f8f8; font-weight: bold; color: #333; }
        .play-button-demo { 
            background: #4CAF50; color: white; border: none; padding: 8px 15px; 
            border-radius: 4px; cursor: pointer; margin-top: 5px; font-size: 14px;
            transition: background 0.3s;
        }
        .play-button-demo:hover { background: #45a049; }
        .play-button-demo:disabled { background: #ccc; cursor: not-allowed; }
        [id*="waveform"] { height: 80px; margin-bottom: 5px; }
        #global-status { 
            position: fixed; top: 20px; right: 20px; padding: 10px 20px; 
            background: #fff; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
            z-index: 9999; min-width: 200px; text-align: center;
        }
        .loading { color: #ff9800; }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .waveform-container { position: relative; }
    </style>
</head>
<body>
<div id="global-status" class="success">请点击播放按钮加载音频</div>
<div class="container">
    <div id="text1">Audio Codec Samples <br/> Playback by Different BPS (640/1200/3000)</div>
    <div id="intro">
        <p>Speech Codec Audio Samples - Groundtruth and Various Codec Comparisons</p>
        <p>Supported BPS: 640bps, 1200bps, 3000bps</p>
        <p>Codecs: groundtruth, encodec, hificodec, ticodec, wavtokenizer, cCodec</p>
    </div>
</div>

<!-- 640bps 音频样本容器 -->
<div class="content-container">
    <div class="content-title">640bps Samples</div>
    <!-- s1 样本表格 -->
    <h3>Sample s1</h3>
    <table class="inlineTable">
        <thead>
            <tr>
                <th>Codec Type</th>
                <th>Waveform</th>
                <th>Playback</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Groundtruth</td>
                <td><div class="waveform-container" id="640_s1_groundtruth"></div></td>
                <td><button class="play-button-demo" onclick="loadAndPlay('640_s1_groundtruth', 'samples/640bps/s1/121_121726_000004_000003.wav')">加载并播放</button></td>
            </tr>
            <tr>
                <td>Encodec</td>
                <td><div class="waveform-container" id="640_s1_encodec"></div></td>
                <td><button class="play-button-demo" onclick="loadAndPlay('640_s1_encodec', 'samples/640bps/s1/121_121726_000004_000003_encodec_640.wav')">加载并播放</button></td>
            </tr>
            <tr>
                <td>HiFiCodec</td>
                <td><div class="waveform-container" id="640_s1_hifi"></div></td>
                <td><button class="play-button-demo" onclick="loadAndPlay('640_s1_hifi', 'samples/640bps/s1/121_121726_000004_000003_hifi_640.wav')">加载并播放</button></td>
            </tr>
            <tr>
                <td>TiCodec</td>
                <td><div class="waveform-container" id="640_s1_ticodec"></div></td>
                <td><button class="play-button-demo" onclick="loadAndPlay('640_s1_ticodec', 'samples/640bps/s1/121_121726_000004_000003_ticodec_640.wav')">加载并播放</button></td>
            </tr>
            <tr>
                <td>WavTokenizer</td>
                <td><div class="waveform-container" id="640_s1_wavt"></div></td>
                <td><button class="play-button-demo" onclick="loadAndPlay('640_s1_wavt', 'samples/640bps/s1/121_121726_000004_000003_wavt_640.wav')">加载并播放</button></td>
            </tr>
            <tr>
                <td>cCodec</td>
                <td><div class="waveform-container" id="640_s1_ccodec"></div></td>
                <td><button class="play-button-demo" onclick="loadAndPlay('640_s1_ccodec', 'samples/640bps/s1/121_121726_000004_000003_cCodec_640.wav')">加载并播放</button></td>
            </tr>
        </tbody>
    </table>

    <!-- s2 样本表格 -->
    <h3>Sample s2</h3>
    <table class="inlineTable">
        <thead>
            <tr>
                <th>Codec Type</th>
                <th>Waveform</th>
                <th>Playback</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Groundtruth</td>
                <td><div class="waveform-container" id="640_s2_groundtruth"></div></td>
                <td><button class="play-button-demo" onclick="loadAndPlay('640_s2_groundtruth', 'samples/640bps/s2/121_121726_000005_000001.wav')">加载并播放</button></td>
            </tr>
            <tr>
                <td>Encodec</td>
                <td><div class="waveform-container" id="640_s2_encodec"></div></td>
                <td><button class="play-button-demo" onclick="loadAndPlay('640_s2_encodec', 'samples/640bps/s2/121_121726_000005_000001_encodec_640.wav')">加载并播放</button></td>
            </tr>
            <tr>
                <td>HiFiCodec</td>
                <td><div class="waveform-container" id="640_s2_hifi"></div></td>
                <td><button class="play-button-demo" onclick="loadAndPlay('640_s2_hifi', 'samples/640bps/s2/121_121726_000005_000001_hifi_640.wav')">加载并播放</button></td>
            </tr>
            <tr>
                <td>TiCodec</td>
                <td><div class="waveform-container" id="640_s2_ticodec"></div></td>
                <td><button class="play-button-demo" onclick="loadAndPlay('640_s2_ticodec', 'samples/640bps/s2/121_121726_000005_000001_ticodec_640.wav')">加载并播放</button></td>
            </tr>
            <tr>
                <td>WavTokenizer</td>
                <td><div class="waveform-container" id="640_s2_wavt"></div></td>
                <td><button class="play-button-demo" onclick="loadAndPlay('640_s2_wavt', 'samples/640bps/s2/121_121726_000005_000001_wavt_640.wav')">加载并播放</button></td>
            </tr>
            <tr>
                <td>cCodec</td>
                <td><div class="waveform-container" id="640_s2_ccodec"></div></td>
                <td><button class="play-button-demo" onclick="loadAndPlay('640_s2_ccodec', 'samples/640bps/s2/121_121726_000005_000001_cCodec_640.wav')">加载并播放</button></td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    // 根路径：GitHub Pages 绝对路径
    const BASE_URL = 'https://shaokai1209.github.io/c-Codec/';
    // 缓存Wavesurfer实例，避免重复创建
    const wavesurferInstances = {};
    const statusEl = document.getElementById('global-status');

    /**
     * 加载并播放音频的核心函数
     * @param {string} containerId - 波形容器ID
     * @param {string} audioPath - 音频相对路径
     */
    function loadAndPlay(containerId, audioPath) {
        // 1. 禁用当前按钮，防止重复点击
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '加载中...';

        // 2. 拼接完整音频URL
        const audioFullUrl = BASE_URL + audioPath;
        statusEl.className = 'loading';
        statusEl.textContent = `正在加载: ${audioPath}`;

        // 3. 如果实例已存在，直接播放；否则创建新实例
        if (wavesurferInstances[containerId]) {
            const ws = wavesurferInstances[containerId];
            ws.playPause();
            btn.textContent = ws.isPlaying() ? '暂停' : '播放';
            statusEl.className = 'success';
            statusEl.textContent = ws.isPlaying() ? `播放中: ${audioPath}` : `已暂停: ${audioPath}`;
            btn.disabled = false;
            return;
        }

        // 4. 创建新的Wavesurfer实例
        const ws = WaveSurfer.create({
            container: `#${containerId}`,
            waveColor: 'violet',
            progressColor: 'purple',
            cursorColor: 'red',
            barWidth: 2,
            barRadius: 3,
            responsive: true,
            height: 80,
            backend: 'WebAudio',
            normalize: true // 归一化波形，避免音量差异
        });

        // 5. 缓存实例
        wavesurferInstances[containerId] = ws;

        // 6. 监听加载状态
        ws.on('loading', (progress) => {
            statusEl.textContent = `加载中: ${audioPath} (${Math.round(progress)}%)`;
        });

        // 7. 加载完成回调
        ws.on('ready', () => {
            ws.play();
            btn.textContent = '暂停';
            btn.disabled = false;
            statusEl.className = 'success';
            statusEl.textContent = `播放中: ${audioPath}`;
        });

        // 8. 播放/暂停切换
        ws.on('play', () => {
            btn.textContent = '暂停';
            statusEl.className = 'success';
            statusEl.textContent = `播放中: ${audioPath}`;
        });

        ws.on('pause', () => {
            btn.textContent = '播放';
            statusEl.className = 'success';
            statusEl.textContent = `已暂停: ${audioPath}`;
        });

        // 9. 错误处理
        ws.on('error', (err) => {
            const errorMsg = `加载失败: ${audioPath} - ${err}`;
            btn.textContent = '重试';
            btn.disabled = false;
            statusEl.className = 'error';
            statusEl.textContent = errorMsg;
            console.error(errorMsg, audioFullUrl);
            alert(errorMsg + '\n请检查音频文件路径是否正确！');
            // 移除错误实例，避免缓存污染
            delete wavesurferInstances[containerId];
            ws.destroy();
        });

        // 10. 加载音频
        ws.load(audioFullUrl);
    }

    // 页面卸载时销毁所有实例，释放资源
    window.onbeforeunload = () => {
        Object.values(wavesurferInstances).forEach(ws => ws.destroy());
    };
</script>
</body>
</html>
